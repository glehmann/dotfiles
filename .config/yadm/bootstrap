#!/bin/sh

set -ex

export PATH=$HOME/.cargo/bin:$HOME/.local/bin:$PATH
. /etc/os-release
cd /tmp

mkdir -p ~/.ssh/ ~/.local/bin/ ~/src/xcp-ng ~/src/xcp-ng-rpms
chmod 700 ~/.ssh
echo ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFJTlLF2DqyJ0TjmfE+Fc8fWc7m/F/43r2FFHxUCiDb4 > ~/.ssh/authorized_keys
if [ "$ID" = "alpine" ]; then
  sudo apk add gcc mold helix git fish kitty-kitten xclip podman htop helix-tree-sitter-vendor curl shadow bash
  sudo rc-update add cgroups default
  sudo rc-service cgroups start
  echo glehmann:100000:65536 | sudo tee -a /etc/subuid | sudo tee -a /etc/subgid
  sudo sed -i -E 's@(\\s+/\\s+ext4\\s+rw,relatime)@\\1,shared@g' /etc/fstab
  sudo mount -a -o remount
elif [ "$ID" = "debian"] || [ "$ID" = "ubuntu" ]; then
  sudo apt update
  sudo apt install -y gcc mold git fish kitty xclip podman htop curl wget
  wget https://github.com/helix-editor/helix/releases/download/25.07.1/helix_25.7.1-1_amd64.deb
  sudo dpkg -i helix_*_amd64.deb
elif [ "$ID" = "freebsd"]; then
  doas pkg install helix git fish xclip podman htop zoxide vivid starship bat eza ripgrep fd-find zellij carapace uv mise jujutsu
  # missing: watchexec yazi zizmor
  sudo chsh -s /usr/local/bin/fish $USER
else
  sudo dnf install -y @development-tools mold helix git fish kitty-kitten xclip podman htop
fi

yadm decrypt
. ~/.secrets.sh
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

if [ `uname -o` == "GNU/Linux" ] || [ `uname -o` == "Linux" ]; then
  sudo chsh -s /usr/bin/fish $USER
  curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | sh
  cargo binstall -y zoxide vivid starship bat eza ripgrep fd-find jj-cli watchexec-cli zellij # yazi-build
  curl -sSL https://github.com/carapace-sh/carapace-bin/releases/download/v1.5.0/carapace-bin_1.5.0_linux_amd64.tar.gz | tar -xvzC ~/.local/bin/ carapace
  curl -LsSf https://astral.sh/uv/install.sh | sh
  uv tool install zizmor
  curl https://mise.run | sh
  wget https://github.com/sxyazi/yazi/releases/download/v25.5.31/yazi-x86_64-unknown-linux-musl.zip && unzip -j -d ~/.local/bin/ yazi-x86_64-unknown-linux-musl.zip '*/yazi' && rm yazi-x86_64-unknown-linux-musl.zip
fi
